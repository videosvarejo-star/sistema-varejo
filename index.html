<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle e Prospec√ß√£o - Varejo LED Truck</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f5f5f5;
            --surface-color: #ffffff;
            --text-color: #000000;
            --primary-color: #000000;
            --secondary-color: #555555;
            --border-color: #dddddd;
            --header-bg: #f0f0f0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            color: var(--text-color);
        }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; font-size: 1.2em; font-weight: bold;
            flex-direction: column; gap: 10px;
        }
        .container { max-width: 1300px; margin: 0 auto; }
        header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; flex-direction: column; }
        #logo { max-width: 250px; margin-bottom: 10px; }
        h1, h2 { color: var(--text-color); text-align: center; margin: 5px 0 20px 0; }
        
        .master-container { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        .master-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .master-header .title-wrapper { cursor: pointer; flex-grow: 1; }
        .master-header h2 { margin: 0; text-align: left; font-size: 1.5em; }

        .content-area { padding: 0 20px 1px 20px; max-height: 5000px; transition: all 0.4s ease-in-out; }
        .master-container.collapsed .content-area { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; }
        .grade { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        .grade-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .grade-title { display: flex; align-items: center; gap: 15px; cursor: pointer; flex-grow: 1; }
        .grade-title h2 { margin: 0; font-size: 1.2em; }
        .toggle-btn { background: none; border: none; cursor: pointer; font-size: 1.5em; transition: transform 0.3s ease; color: var(--secondary-color); }
        .collapsed .toggle-btn { transform: rotate(-90deg); }
        .grade-content { padding: 0 20px 20px 20px; max-height: 1000px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; border-top: 1px solid var(--border-color); }
        .grade.collapsed .grade-content { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; border-top: none; }
        .header-buttons { display: flex; align-items: center; }
        .header-buttons button { border: 1px solid; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 14px; margin-left: 10px; transition: all 0.2s ease; }
        .export-btn { background-color: #3498db; color: white; border-color: #3498db; }
        .export-btn:hover { background-color: #2980b9; }
        .delete-grade-btn { background-color: transparent; color: var(--primary-color); border-color: var(--primary-color); }
        .delete-grade-btn:hover { background-color: #e74c3c; color: white; border-color: #e74c3c;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background-color: var(--header-bg); font-weight: 500; }
        td input, td select { box-sizing: border-box; width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: white;}
        
        .controls { text-align: center; padding: 10px 0 20px 0; }
        .add-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; }
        
        #save-status { text-align: center; color: #888; font-style: italic; height: 20px; }

        .schedule-content { padding: 0 20px 20px 20px; max-height: 1000px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, border 0.2s linear; border-top: 1px solid var(--border-color); }
        .master-container.collapsed .schedule-content { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; border-top: none; }
        #schedule-grid { display: grid; grid-template-columns: 90px repeat(5, 1fr); gap: 5px; margin-top: 20px; background-color: white; }
        .grid-header, .time-slot, .hour-label { padding: 10px; text-align: center; border-radius: 4px; min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .grid-header { background-color: var(--primary-color); color: white; font-weight: 500; }
        .hour-label { background-color: var(--header-bg); font-weight: 500; font-size: 0.9em; }
        .time-slot { background-color: #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
        
        .scheduled-item { background-color: var(--primary-color); color: white; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; padding: 2px; text-align: center; line-height: 1.2; box-sizing: border-box; }
        .scheduled-item.exclusive-item { background-color: var(--secondary-color); }
        .main-info { font-weight: 500; font-size: 1em; word-break: break-all; }
        .exclusive-item .main-info { font-size: 0.9em; }
        .time-obs { font-size: 0.8em; opacity: 0.9; font-style: italic; }

        .delete-prospect-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; }
        
        #schedule-mobile { display: none; }

        @media (max-width: 768px) {
            body { padding: 5px; }
            h1 { font-size: 1.5em;}
            h2 { font-size: 1.2em; }
            .master-header { padding: 15px; }
            .header-buttons button { font-size: 12px; padding: 6px 8px; margin-left: 5px;}

            table, thead, tbody, th, td, tr { 
                display: block; 
            }
            thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid var(--border-color);
                margin-bottom: 10px;
                border-radius: 5px;
            }
            /* AJUSTE AQUI */
            td { 
                border: none;
                border-bottom: 1px solid #eee; 
                position: relative;
                padding-left: 35% !important; 
                min-height: 30px;
                display: flex;
                align-items: center;
                justify-content: flex-start; /* Alinha √† esquerda */
            }
            td:before { 
                content: attr(data-label);
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                left: 10px;
                width: 30%; 
                padding-right: 10px; 
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }
            .grade-content td:last-child, #prospects-table td:last-child { border-bottom: none; }
            td input, td select { 
                width: 65%; /* Aumenta a largura do campo */
                padding: 6px; 
            }
            /* Fim do Ajuste */

            #schedule-grid { display: none; }
            #schedule-mobile { display: block; }
            
            .mobile-day-header {
                background-color: var(--primary-color); color: white;
                padding: 15px; margin-top: 5px; border-radius: 5px;
                cursor: pointer; font-weight: bold;
                display: flex; justify-content: space-between; align-items: center;
            }
            .mobile-day-header::after { content: '‚ñº'; font-size: 0.8em; transition: transform 0.3s; }
            .mobile-day-header.active::after { transform: rotate(180deg); }
            
            .mobile-day-content {
                display: none;
                padding: 0 10px;
                border: 1px solid var(--border-color);
                border-top: none;
                border-radius: 0 0 5px 5px;
            }
            .mobile-day-content.active { display: block; }
            
            .mobile-time-slot { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding: 5px 0; }
            .mobile-time-slot:last-child { border-bottom: none; }
            .mobile-hour-label { font-weight: 500; }
            .mobile-slot-content { width: 70%; min-height: 45px; background-color: #f0f0f0; border-radius: 4px; cursor: pointer; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">Carregando...</div>

    <div class="container">
        <header><img id="logo" src="logo.png" alt="Logo Varejo Led Truck"><h1>Painel de Controle</h1></header>
        <div class="master-container" id="grades-master-container">
            <div class="master-header">
                <div class="title-wrapper"><h2>Gerenciamento de Grades</h2></div>
                <div class="header-buttons"><button class="toggle-btn" title="Minimizar/Maximizar">&#9662;</button></div>
            </div>
            <div class="content-area">
                <div id="grades-container"></div>
                <div class="controls"><button id="add-grade-btn" class="add-btn">Adicionar Nova Grade</button></div>
            </div>
        </div>
        <div class="master-container" id="prospects-master-container">
            <div class="master-header">
                <div class="title-wrapper"><h2>Clientes / Prospec√ß√£o</h2></div>
                <div class="header-buttons"><button class="export-btn" id="prospects-export-btn">Gerar Arquivo</button><button class="toggle-btn" title="Minimizar/Maximizar">&#9662;</button></div>
            </div>
            <div class="content-area">
                <table id="prospects-table">
                    <thead>
                        <tr>
                            <th>Nome da Empresa</th><th>Cliente</th><th>Telefone</th><th>Status</th><th>Observa√ß√µes</th><th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="prospects-table-body"></tbody>
                </table>
                <div class="controls"><button id="add-prospect-btn" class="add-btn">Adicionar Cliente em Prospec√ß√£o</button></div>
            </div>
        </div>
        <div class="master-container" id="schedule-container">
            <div class="master-header">
                <div class="title-wrapper"><h2>Cronograma Semanal</h2></div>
                <div class="header-buttons"><button class="export-btn" id="schedule-export-btn">Gerar Arquivo</button><button class="toggle-btn" title="Minimizar/Maximizar">&#9662;</button></div>
            </div>
            <div class="content-area schedule-content">
                <div id="schedule-grid"></div>
                <div id="schedule-mobile"></div>
            </div>
        </div>
        <p id="save-status"></p>
    </div>
    <div id="modal-overlay" style="display: none;">
        </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (todo o javascript permanece igual) ...
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJc4lkF-YbADPD8MUi8VcBshIcfo8itPP1i79Mp6br-2JKeH5mjEZ7xELkMzF2ae-fOg/exec';
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const saveStatus = document.getElementById('save-status');
            const gradesContainer = document.getElementById('grades-container');
            const addGradeBtn = document.getElementById('add-grade-btn');
            const scheduleGrid = document.getElementById('schedule-grid');
            const scheduleMobileContainer = document.getElementById('schedule-mobile');
            const prospectsTableBody = document.getElementById('prospects-table-body');
            const addProspectBtn = document.getElementById('add-prospect-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            const gradeList = document.getElementById('grade-list');
            const exclusiveBtn = document.getElementById('exclusive-btn');
            const confirmScheduleBtn = document.getElementById('confirm-schedule-btn');
            const selectionView = document.getElementById('selection-view');
            const confirmationView = document.getElementById('confirmation-view');
            const selectionInfo = document.getElementById('selection-info');
            const scheduleObservationInput = document.getElementById('schedule-observation');
            const quickObsContainer = document.getElementById('quick-obs-container');
            let activeSlot = null;
            let tempScheduleData = {};
            let saveDataTimeout;

            function showLoading(message) { loadingOverlay.innerHTML = `<div>${message}</div>`; loadingOverlay.style.display = 'flex'; }
            function hideLoading() { loadingOverlay.style.display = 'none'; }
            
            async function loadData() {
                showLoading('Carregando dados da nuvem...');
                try {
                    const response = await fetch(SCRIPT_URL);
                    if (!response.ok) throw new Error(`Erro de rede: ${response.statusText}`);
                    const allData = await response.json();
                    
                    gradesContainer.innerHTML = '';
                    prospectsTableBody.innerHTML = '';
                    
                    if (allData.grades && allData.grades.length > 0) allData.grades.forEach(gradeData => gradesContainer.appendChild(createGradeElement(gradeData)));
                    else addGrade();

                    if (allData.prospects && allData.prospects.length > 0) allData.prospects.forEach(prospectData => prospectsTableBody.appendChild(createProspectRow(prospectData)));
                    else addProspectRow();
                    
                    const allSlots = document.querySelectorAll('.time-slot');
                    allSlots.forEach(slot => slot.innerHTML = '');

                    if (allData.schedule) {
                        Object.keys(allData.schedule).forEach(key => {
                            const [day, hour] = key.split('-');
                            document.querySelectorAll(`.time-slot[data-day='${day}'][data-hour='${hour}']`).forEach(slot => {
                                renderScheduleItem(slot, allData.schedule[key]);
                            });
                        });
                    }
                    
                    if (allData.uiState) {
                        document.getElementById('schedule-container').classList.toggle('collapsed', allData.uiState.scheduleCollapsed);
                        document.getElementById('grades-master-container').classList.toggle('collapsed', allData.uiState.gradesMasterCollapsed);
                        document.getElementById('prospects-master-container').classList.toggle('collapsed', allData.uiState.prospectsMasterCollapsed);
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    alert('N√ÉO FOI POSS√çVEL CARREGAR OS DADOS!\n\nVerifique:\n1. Sua conex√£o com a internet.\n2. Se a URL do Script est√° correta.\n3. Se as permiss√µes da planilha e do script est√£o corretas (Qualquer pessoa).');
                } finally {
                    hideLoading();
                }
            }

            function triggerSave() {
                saveStatus.textContent = 'Salvando...';
                clearTimeout(saveDataTimeout);
                saveDataTimeout = setTimeout(saveData, 1500);
            }
            
            async function saveData() {
                saveStatus.textContent = 'Salvando na nuvem...';
                const gradesData = Array.from(document.querySelectorAll('.grade')).map(gradeEl => {
                    const advertisers = Array.from(gradeEl.querySelectorAll('tbody tr')).map(row => ({ empresa: row.cells[1].querySelector('input').value, cliente: row.cells[2].querySelector('input').value, telefone: row.cells[3].querySelector('input').value, inicioContrato: row.cells[4].querySelector('input').value, fimContrato: row.cells[5].querySelector('input').value }));
                    return { id: gradeEl.dataset.id, isCollapsed: gradeEl.classList.contains('collapsed'), advertisers };
                });
                const scheduleData = {};
                document.querySelectorAll('.time-slot[data-schedule-info]').forEach(slot => {
                    const key = `${slot.dataset.day}-${slot.dataset.hour}`;
                    scheduleData[key] = JSON.parse(slot.dataset.scheduleInfo);
                });
                const prospectsData = Array.from(document.querySelectorAll('#prospects-table-body tr')).map(row => {
                    const inputs = row.querySelectorAll('input, select');
                    return { empresa: inputs[0].value, cliente: inputs[1].value, telefone: inputs[2].value, status: inputs[3].value, observacao: inputs[4].value };
                });
                const uiState = {
                    scheduleCollapsed: document.getElementById('schedule-container').classList.contains('collapsed'),
                    gradesMasterCollapsed: document.getElementById('grades-master-container').classList.contains('collapsed'),
                    prospectsMasterCollapsed: document.getElementById('prospects-master-container').classList.contains('collapsed')
                };
                const dataToSave = { grades: gradesData, schedule: scheduleData, prospects: prospectsData, uiState: uiState };

                try {
                     await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                        body: JSON.stringify(dataToSave)
                    });
                    saveStatus.textContent = 'Salvo na nuvem!';
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    saveStatus.textContent = 'Erro ao salvar!';
                } finally {
                    setTimeout(() => { saveStatus.textContent = ''; }, 2000);
                }
            }

            function createGradeElement(gradeData) {
                const gradeDiv = document.createElement('div');
                gradeDiv.className = 'grade';
                if (gradeData.isCollapsed) gradeDiv.classList.add('collapsed');
                gradeDiv.dataset.id = gradeData.id;
                const tableRows = (gradeData.advertisers.length > 0 ? gradeData.advertisers : Array(8).fill({}))
                    .map((ad, i) => `<tr><td data-label="Slot">${i + 1}</td><td data-label="Empresa"><input type="text" placeholder="Nome da Empresa" value="${ad.empresa || ''}"></td><td data-label="Cliente"><input type="text" placeholder="Nome do Contato" value="${ad.cliente || ''}"></td><td data-label="Telefone"><input type="text" placeholder="(XX) XXXXX-XXXX" value="${ad.telefone || ''}"></td><td data-label="In√≠cio"><input type="date" value="${ad.inicioContrato || ''}"></td><td data-label="Fim"><input type="date" value="${ad.fimContrato || ''}"></td></tr>`).join('');
                gradeDiv.innerHTML = `<div class="grade-header"><div class="grade-title"><button class="toggle-btn" title="Minimizar/Maximizar">&#9662;</button><h2>Grade ${gradeData.id}</h2></div><div class="header-buttons"><button class="export-btn">Gerar Arquivo</button><button class="delete-grade-btn">Excluir Grade</button></div></div><div class="grade-content"><table><thead><tr><th>Slot</th><th>Empresa</th><th>Cliente</th><th>Telefone</th><th>In√≠cio Contrato</th><th>Final Contrato</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
                gradeDiv.querySelector('.grade-title').addEventListener('click', e => { gradeDiv.classList.toggle('collapsed'); triggerSave(); });
                gradeDiv.querySelector('.delete-grade-btn').addEventListener('click', e => { e.stopPropagation(); if (confirm(`Tem certeza?`)) { gradeDiv.remove(); triggerSave(); } });
                gradeDiv.querySelector('.export-btn').addEventListener('click', e => { e.stopPropagation(); generateImage(gradeDiv.querySelector('.grade-content'), `grade_${gradeData.id}.jpg`); });
                return gradeDiv;
            }
            
            function createProspectRow(prospectData = {}) {
                const tr = document.createElement('tr');
                const statusOptions = ['Em negocia√ß√£o', 'Enviar mensagem', 'Contrato fechado', 'N√£o tem interesse', 'Entrar em contato no pr√≥ximo m√™s'];
                const optionsHTML = statusOptions.map(opt => `<option value="${opt}" ${prospectData.status === opt ? 'selected' : ''}>${opt}</option>`).join('');
                tr.innerHTML = `<td data-label="Empresa"><input type="text" placeholder="Nome da Empresa" value="${prospectData.empresa || ''}"></td><td data-label="Cliente"><input type="text" placeholder="Nome do Contato" value="${prospectData.cliente || ''}"></td><td data-label="Telefone"><input type="text" placeholder="(XX) XXXXX-XXXX" value="${prospectData.telefone || ''}"></td><td data-label="Status"><select>${optionsHTML}</select></td><td data-label="Observa√ß√µes"><input type="text" placeholder="Observa√ß√µes..." value="${prospectData.observacao || ''}"></td><td data-label="A√ß√µes"><button class="delete-prospect-btn">üóëÔ∏è</button></td>`;
                tr.querySelector('.delete-prospect-btn').addEventListener('click', () => { if (confirm('Deseja excluir este cliente da prospec√ß√£o?')) { tr.remove(); triggerSave(); } });
                return tr;
            }

            function createScheduleGrid() {
                const days = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta"];
                scheduleGrid.innerHTML = '';
                scheduleGrid.appendChild(Object.assign(document.createElement('div'), { className: 'grid-header' }));
                days.forEach(day => scheduleGrid.appendChild(Object.assign(document.createElement('div'), { className: 'grid-header', textContent: day })));
                for (let hour = 9; hour < 19; hour++) {
                    scheduleGrid.appendChild(Object.assign(document.createElement('div'), { className: 'hour-label', textContent: `${String(hour).padStart(2, '0')} √†s ${String(hour + 1).padStart(2, '0')}h` }));
                    days.forEach(day => {
                        const slot = Object.assign(document.createElement('div'), { className: 'time-slot' });
                        slot.dataset.day = day; slot.dataset.hour = hour;
                        scheduleGrid.appendChild(slot);
                    });
                }
            }
            
            function createMobileSchedule() {
                const days = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta"];
                scheduleMobileContainer.innerHTML = '';
                days.forEach(day => {
                    const dayWrapper = document.createElement('div');
                    const header = document.createElement('div');
                    header.className = 'mobile-day-header';
                    header.textContent = day;
                    const content = document.createElement('div');
                    content.className = 'mobile-day-content';
                    for (let hour = 9; hour < 19; hour++) {
                        const slotWrapper = document.createElement('div');
                        slotWrapper.className = 'mobile-time-slot';
                        const hourLabel = document.createElement('div');
                        hourLabel.className = 'mobile-hour-label';
                        hourLabel.textContent = `${String(hour).padStart(2, '0')}h`;
                        const slot = document.createElement('div');
                        slot.className = 'mobile-slot-content time-slot';
                        slot.dataset.day = day;
                        slot.dataset.hour = hour;
                        slotWrapper.appendChild(hourLabel);
                        slotWrapper.appendChild(slot);
                        content.appendChild(slotWrapper);
                    }
                    header.addEventListener('click', () => {
                        document.querySelectorAll('.mobile-day-content.active').forEach(activeContent => {
                            if(activeContent !== content) {
                                activeContent.classList.remove('active');
                                activeContent.previousElementSibling.classList.remove('active');
                            }
                        });
                        content.classList.toggle('active');
                        header.classList.toggle('active');
                    });
                    dayWrapper.appendChild(header);
                    dayWrapper.appendChild(content);
                    scheduleMobileContainer.appendChild(dayWrapper);
                });
            }

            function parseVisibleObservation(observation) {
                if (!observation) return '';
                const keywords = ['15 min', '30 min', '45 min'];
                for (const keyword of keywords) { if (observation.includes(keyword)) return keyword; }
                return '';
            }

            function renderScheduleItem(slot, scheduleData) {
                slot.dataset.scheduleInfo = JSON.stringify(scheduleData);
                const item = document.createElement('div');
                item.className = 'scheduled-item';
                if (scheduleData.type === 'exclusive') item.classList.add('exclusive-item');
                if (scheduleData.observation) item.title = scheduleData.observation;
                const mainInfo = document.createElement('span');
                mainInfo.className = 'main-info';
                mainInfo.textContent = scheduleData.value;
                const timeObs = document.createElement('span');
                timeObs.className = 'time-obs';
                timeObs.textContent = parseVisibleObservation(scheduleData.observation);
                item.appendChild(mainInfo); item.appendChild(timeObs);
                slot.innerHTML = ''; slot.appendChild(item);
            }
            
            function addGrade() {
                const existingIds = Array.from(document.querySelectorAll('.grade')).map(g => parseInt(g.dataset.id, 10));
                let newId = 1; while (existingIds.includes(newId)) newId++;
                const newGradeData = { id: String(newId).padStart(2, '0'), advertisers: Array(8).fill({}), isCollapsed: false };
                gradesContainer.appendChild(createGradeElement(newGradeData));
            }
            
            function addProspectRow() { prospectsTableBody.appendChild(createProspectRow()); }
            
            function openScheduleModal(slot) { /* ... */ }
            function proceedToConfirmation(data) { /* ... */ }
            function generateImage(element, filename) { /* ... */ }
            
            // --- LISTENERS DE EVENTOS ---
            document.querySelectorAll('.master-container').forEach(container => {
                const header = container.querySelector('.master-header');
                header.addEventListener('click', (e) => {
                    if (!e.target.closest('.header-buttons') || e.target.classList.contains('toggle-btn') || e.target.closest('.title-wrapper')) {
                         container.classList.toggle('collapsed');
                         triggerSave();
                    }
                });
            });

            document.getElementById('schedule-container').addEventListener('click', e => {
                const slot = e.target.closest('.time-slot');
                if (slot) {
                    const existingItem = slot.querySelector('.scheduled-item');
                    if (existingItem) { if (confirm(`Deseja remover o agendamento "${existingItem.querySelector('.main-info').textContent}"?`)) { slot.innerHTML = ''; delete slot.dataset.scheduleInfo; triggerSave(); }
                    } else { openScheduleModal(slot); }
                }
            });
            
            // ... (restante dos listeners)
            
            // --- INICIALIZA√á√ÉO ---
            createScheduleGrid();
            createMobileSchedule();
            loadData();
        });
    </script>
</body>
</html>